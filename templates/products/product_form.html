{% extends 'base.html' %}
{% load l10n %}

{% block content %}
<div class="max-w-2xl mx-auto mt-10">
    <div class="card">
        <header>
            <h2 class="text-2xl font-bold">{% if form.instance.pk %}Editar Produto{% else %}Novo Produto{% endif %}</h2>
            <p>Preencha os detalhes abaixo para gerenciar seu produto no inventário.</p>
        </header>

        {% if form.errors %}
        <div class="px-6 pt-2">
            <div class="alert alert-destructive">
                <section>
                    <p>Por favor, corrija os erros abaixo.</p>
                </section>
            </div>
        </div>
        {% endif %}

        <form method="post" class="product-form">
            {% csrf_token %}

            <section class="flex flex-col gap-6 py-6 px-6">
                <div class="field">
                    <label for="id_name" class="text-foreground font-medium mb-1.5">Nome do Produto</label>
                    <input type="text" name="name" id="id_name" placeholder="Ex: Cadeira Ergonômica"
                        value="{{ form.name.value|default:'' }}" class="input w-full" required>
                    {% if form.name.errors %}<p class="text-destructive text-xs mt-1">{{ form.name.errors.0 }}</p>
                    {% endif %}
                </div>

                <div class="field">
                    <label for="id_description" class="text-foreground font-medium mb-1.5">Descrição (Opcional)</label>
                    <textarea name="description" id="id_description"
                        placeholder="Descreva as principais características do produto..."
                        class="input w-full min-h-[120px]">{{ form.description.value|default:'' }}</textarea>
                    {% if form.description.errors %}<p class="text-destructive text-xs mt-1">
                        {{ form.description.errors.0 }}</p>{% endif %}
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="field">
                        <label for="id_price" class="text-foreground font-medium mb-1.5">Preço (R$)</label>
                        <div class="relative">
                            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-muted-foreground">R$</span>
                            <input type="text" name="price" id="id_price" placeholder="0,00"
                                value="{{ form.price.value|localize|default:'' }}" class="input w-full pl-10"
                                required>
                        </div>
                        {% if form.price.errors %}<p class="text-destructive text-xs mt-1">{{ form.price.errors.0 }}</p>
                        {% endif %}
                    </div>

                    <div class="field">
                        <label for="id_stock" class="text-foreground font-medium mb-1.5">Quantidade em Estoque</label>
                        <input type="number" name="stock" id="id_stock" placeholder="0"
                            value="{{ form.stock.value|unlocalize|default:'' }}" class="input w-full" required>
                        {% if form.stock.errors %}<p class="text-destructive text-xs mt-1">{{ form.stock.errors.0 }}</p>
                        {% endif %}
                    </div>
                </div>

                <div class="field">
                    <label class="text-foreground font-medium mb-1.5 block font-bold">Categorias</label>
                    <div class="space-y-3 relative">
                        <!-- Search and Selected Badges Area -->
                        <div class="card p-3 bg-muted/20 border-dashed min-h-[50px] flex flex-wrap gap-2 items-center" id="category-tags-container">
                            <!-- Badges will be injected here via JS -->
                            <input type="text" id="category-search" placeholder="Pesquisar categoria..."
                                   class="bg-transparent border-none outline-none text-sm flex-1 min-w-[150px] focus:ring-0">
                        </div>

                        <!-- Search Results Dropdown -->
                        <div id="category-results" class="hidden card absolute z-20 w-full max-h-48 overflow-y-auto shadow-xl border-border p-1 animate-in fade-in slide-in-from-top-2 duration-200">
                            <!-- Results injected here -->
                        </div>

                        <!-- Actual Hidden Native Checkboxes -->
                        <div class="hidden" id="hidden-categories">
                            {{ form.categories }}
                        </div>
                    </div>
                    {% if form.categories.errors %}<p class="text-destructive text-xs mt-1">{{ form.categories.errors.0 }}</p>{% endif %}
                </div>

                <div class="field p-4 bg-muted/30 rounded-lg border border-border transition-colors hover:bg-muted/50">
                    <label for="id_is_public" class="flex items-start gap-3 cursor-pointer select-none">
                        <input type="checkbox" name="is_public" id="id_is_public"
                            class="shrink-0 mt-1 w-4 h-4 rounded border-border text-primary focus:ring-primary"
                            {% if form.is_public.value %}checked{% endif %}>
                        <div>
                            <span class="block font-medium whitespace-nowrap">Produto Público</span>
                            <span class="block text-xs text-muted-foreground mt-0.5">
                                Produtos públicos podem ser visualizados por qualquer pessoa no catálogo global.
                            </span>
                        </div>
                    </label>
                </div>
            </section>

            <footer class="flex justify-end gap-3 pt-6 border-t border-border mt-4 px-6">
                <a href="{% url 'product_list' %}"
                    class="btn btn-ghost bg-transparent border border-border text-foreground hover:bg-muted flex-1 md:flex-none justify-center font-medium">
                    Cancelar
                </a>
                <button type="submit"
                    class="btn btn-ghost bg-primary text-primary-foreground hover:bg-primary/90 flex-1 md:flex-none justify-center font-bold px-8">
                    {% if form.instance.pk %}Atualizar Produto{% else %}Criar Produto{% endif %}
                </button>
            </footer>
        </form>
    </div>
</div>

<script>
    // Focus first input on load
    document.addEventListener('DOMContentLoaded', () => {
        const firstInput = document.getElementById('id_name');
        if (firstInput) firstInput.focus();

        // --- Price Formatting ---
        const priceInput = document.getElementById('id_price');
        if (priceInput) {
            const formatPrice = (val) => {
                let value = val.replace(/\D/g, '');
                if (value === '') return '';
                value = (value / 100).toFixed(2) + '';
                value = value.replace(".", ",");
                value = value.replace(/(\d)(\d{3})(\d{3}),/g, "$1.$2.$3,");
                value = value.replace(/(\d)(\d{3}),/g, "$1.$2,");
                return value;
            };

            priceInput.addEventListener('input', (e) => {
                e.target.value = formatPrice(e.target.value);
            });

            if (priceInput.value) {
                priceInput.value = formatPrice(priceInput.value);
            }
        }

        // --- Multi-Category Selector Logic ---
        const searchInput = document.getElementById('category-search');
        const resultsDiv = document.getElementById('category-results');
        const tagsContainer = document.getElementById('category-tags-container');
        const hiddenDiv = document.getElementById('hidden-categories');
        const checkboxes = hiddenDiv.querySelectorAll('input[type="checkbox"]');

        const updateBadges = () => {
            // Remove existing badges
            tagsContainer.querySelectorAll('.badge').forEach(b => b.remove());

            checkboxes.forEach(cb => {
                if (cb.checked) {
                    const label = cb.parentElement.textContent.trim();
                    const badge = document.createElement('span');
                    badge.className = 'badge bg-primary text-primary-foreground flex items-center gap-1.5 py-1 px-2.5 rounded-full text-xs font-bold shadow-sm animate-in zoom-in duration-200';
                    badge.innerHTML = `
                        ${label}
                        <button type="button" class="hover:text-destructive-foreground transition-colors" data-id="${cb.value}">
                            <i data-lucide="x" class="w-3 h-3"></i>
                        </button>
                    `;
                    tagsContainer.insertBefore(badge, searchInput);

                    badge.querySelector('button').addEventListener('click', (e) => {
                        cb.checked = false;
                        updateBadges();
                    });
                }
            });
            lucide.createIcons();
        };

        const showResults = (query) => {
            resultsDiv.innerHTML = '';
            const filtered = Array.from(checkboxes).filter(cb => {
                const label = cb.parentElement.textContent.trim().toLowerCase();
                return label.includes(query.toLowerCase());
            });

            if (filtered.length > 0 && query.length > 0) {
                resultsDiv.classList.remove('hidden');
                filtered.forEach(cb => {
                    const label = cb.parentElement.textContent.trim();
                    const item = document.createElement('div');
                    item.className = `p-2.5 flex justify-between items-center cursor-pointer hover:bg-muted transition-colors rounded-md ${cb.checked ? 'bg-primary/5 text-primary font-bold' : ''}`;
                    item.innerHTML = `
                        <span>${label}</span>
                        ${cb.checked ? '<i data-lucide="check" class="w-4 h-4"></i>' : '<i data-lucide="plus" class="w-4 h-4 opacity-30"></i>'}
                    `;
                    item.onclick = () => {
                        cb.checked = !cb.checked;
                        updateBadges();
                        searchInput.value = '';
                        resultsDiv.classList.add('hidden');
                    };
                    resultsDiv.appendChild(item);
                });
                lucide.createIcons();
            } else {
                resultsDiv.classList.add('hidden');
            }
        };

        searchInput.addEventListener('input', (e) => showResults(e.target.value));
        searchInput.addEventListener('focus', (e) => showResults(e.target.value));

        // Close results on click outside
        document.addEventListener('click', (e) => {
            if (!searchInput.contains(e.target) && !resultsDiv.contains(e.target)) {
                resultsDiv.classList.add('hidden');
            }
        });

        // Initialize badges (for edit mode)
        updateBadges();
    });
</script>
{% endblock %}